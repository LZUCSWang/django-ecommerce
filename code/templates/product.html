{% extends "base.html" %}
{% load grav_tag %}
{% load is_like %}
{% block main_content %}
    <div class="wrap-content movie">
        <article>
            <div class="art-header">
                <div class="row">
                    <div class="col-md-3 " style="margin-bottom: 10px ;margin-top: 10px">
                        <img src="{{ MEDIA_URL }}{{ product.image_link }}"/>
                    </div>
                    <div class="col-md-9">
                        <div class="wrap-col" style="overflow: auto">
                            <ul class="movie-info" style="overflow: auto">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p style="font-size: 16px;color: #666666;">{{ product.name }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p style="font-size: 16px;color: #666666;">{{ product.shop_name }}</p>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p style="color:#e4393c;font-size: 16px;">{{ product.price }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p style="color: #666666;;font-size: 16px;">店铺类型: {{ product.shop_type}}</p>
                                    </div>
                                </div>
                                <li>
                                    <div class="row">
                                        <div class="col-1-3">
                                            <a target="_blank" style="display: inline-block; margin-left: 15px" class="btn-lg btn-success" href="{{ product.origin_product_link }}">前往购买</a>
                                        </div>
                                        <div class="col-1-3">
                                            {% if is_collect %}
                                                <a class="btn-lg btn-warning" style="display: inline-block" href="{% url 'decollect' product.id %}">取消收藏</a>
                                            {% else %}
                                                <a class="btn-lg btn-primary" style="display: inline-block" href="{% url 'collect' product.id %}">点击收藏</a>{% endif %}
                                        </div>
                                        <div class="col-1-3">
                                            <h2 style="display: inline"> 收藏人数:{{ product.collect.count }} </h2>
                                        </div>
                                        {#                                            <a style="display: inline-block" class="btn-lg btn-primary" href="{% url 'collect' movie.id %}">收藏</a>#}
                                    </div>
                                <li>
                                </li>
                                <li style="margin-top: 20px"><p style="display: inline-block; margin-right: 15px;font-size: 16px;color: #666666;">评价: {{ product.d_rate_nums }}</p>
                                    <p style="display: inline-block">标签： {% for tag in product.tags.all %}  <a href="{% url 'one_tag' tag.id %}">{{ tag.name }}</a>{% endfor %}</p>
                                </li>
                                <li style="margin-top: 20px">
                                    {% if user_rate is not None %}
                                        <h4 style="color: #666666;font-size: 18px;">您已对当前电商产品打过分: {{ user_rate.mark }}</h4>
                                    {% else %}
                                        <form action="{% url 'score' product.id %}" method="post">
                                            {% csrf_token %}
                                            <p style="display: inline-block;"> 添加评分</p>
                                            <select name="score">
                                                <option>1.0</option>
                                                <option>2.0</option>
                                                <option>3.0</option>
                                                <option>4.0</option>
                                                <option>5.0</option>
                                            </select>
                                            <button type="submit" class="button bt1">提交</button>
                                        </form>
                                    {% endif %}
                                </li>
                                                            <div class="clear"></div>

                            </ul>
                        </div>
                    </div>
                </div>
            </div>
                        <div class="clear"></div>
        </article>
        <div class="widget wid-related">
            <div class="wid-header">
                <div class="row">
                    <div class="col-md-9">
                        <h5>基于物品推荐电商产品</h5>
                    </div>
                    <div class="col-md-3">
                        <button class="button bt1" onclick="get_item_recommend()">换一批</button>
                    </div>
                </div>
            </div>
            <div class="wid-content">
                <div class="row" id="item-recommend">
                </div>
            </div>
        </div>
    </div>
    <div style="margin: 20px 20px 20px 0px" class="movie">
        <div class="comments-container">
            <!-- 评论输入框 -->
            <div class="comment-form">
                <form action="{% url 'comment' product.id %}" method="post">
                    {% csrf_token %}
                    <div class="input-wrapper">
                        <textarea class="comment-input" name="comment" placeholder="分享你的想法..." rows="3"></textarea>
                        <button type="submit" class="comment-submit">
                            <i class="fas fa-paper-plane"></i>
                            发表评论
                        </button>
                    </div>
                </form>
            </div>

            <!-- 评论列表 -->
            <div class="comments-list">
                <h2 class="comments-title">
                    <i class="far fa-comments"></i>
                    评论（{{ comments|length }}）
                </h2>
                {% for comment in comments %}
                <div class="comment-item">
                    <div class="comment-avatar">
                        <img src='{{ comment.user.email|gravatar:"48" }}' alt="用户头像">
                    </div>
                    <div class="comment-content">
                        <div class="comment-header">
                            <span class="comment-author">{{ comment.user.username }}</span>
                            <span class="comment-time">{{ comment.create_time|date:"Y-m-d H:i" }}</span>
                        </div>
                        <div class="comment-text">{{ comment.content }}</div>
                        <div class="comment-actions">
                            <a href="{% url 'like_comment' comment.id product.id %}" 
                               class="like-btn {% if user in comment.likes.all %}liked{% endif %}">
                                <i class="far {% if user in comment.likes.all %}fas{% endif %} fa-heart"></i>
                                <span>{{ comment.likecomment_set.count }}</span>
                            </a>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="no-comments">
                    <i class="far fa-comment-dots"></i>
                    <p>暂无评论，来说说你的看法吧～</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

{% endblock %}

{% block bottom-js %}
<script>
    function get_item_recommend() {
        // 从页面上下文获取当前商品ID 
        var current_product_id = "{{ product.id }}";  // 使用Django模板变量
        console.log("Current product ID:", current_product_id); // 调试输出
        
        $.ajax({
            url: '/item_recommend/',
            type: 'GET',
            data: {
                'product_id': current_product_id  // 确保参数名匹配
            },
            success: function(result) {
                var html = "";
                var array_length = result.length;
                for (var i = 0; i < array_length; i++) {
                    html += `<div class="col-1-3"><div class="wrap-col">` +
                        `<a href="/product/${result[i].id}"><img src="${result[i].image_link}"/></a>` +
                        `<a href="/product/${result[i].id}" title="${result[i].name}"><h3>${result[i].name.substring(0, 20)}</h3></a></div></div>`;
                }
                $('#item-recommend').html(html);
            }
        });
    }

    // 页面加载完成后立即调用
    get_item_recommend();
</script>
{% endblock %}
